---
// src/components/DynamicWorkflow.astro
import ImageUploader from './ImageUploader.astro';
import ImageEditor from './ImageEditor.astro';
import PromptInput from './PromptInput.astro';
import ToggleWithText from './ToggleWithText.astro';
import { getTranslator } from '@gudupao/astro-i18n';
import { getWorkflowFormSchema, executeWorkflowWithForm, getExecutionStatus, cancelExecution } from '../api/workflows';

interface WorkflowParam {
 node_id: string;
  title: string;
  class_type: string;
}

interface Props {
  params: WorkflowParam[];
  workflowId: string;
  executionResult?: any;
  executionError?: string | null;
}

const { params = [], workflowId, executionResult, executionError } = Astro.props;

// Get language from params or cookie
const lang = Astro.params.lang || Astro.cookies.get('lang')?.value || 'en';
const t = getTranslator(lang);
---

<!-- Image Editor Modal -->
<ImageEditor />

<div class="workflow-container">
  {
    params.map((param) => (
      <div class="component-wrapper">
        {(() => {
          if (param.class_type === 'LoadImageOutput') {
            return <ImageUploader />;
          } else if (param.class_type === 'Text') {
            return <PromptInput placeholder={param.title} />;
          } else if (param.class_type === 'Switch any [Crystools]') {
            return <ToggleWithText text={param.title} />;
          } else {
            return (
              <div class="unknown-component">
                <p>{t('dynamicworkflow.unknownComponent')}: {param.class_type}</p>
                <p>{t('dynamicworkflow.nodeId')}: {param.node_id}</p>
                <p>{t('dynamicworkflow.title')}: {param.title}</p>
              </div>
            );
          }
        })()}
      </div>
    ))
  }
  
  <div class="workflow-controls">
    <form method="post" action={`/wfs/${workflowId}/execute`}>
      <input type="hidden" name="workflowId" value={workflowId} />
      <input type="hidden" name="params" value={JSON.stringify(params)} />
      <button
        class="execute-btn"
        type="submit"
      >
        {t('dynamicworkflow.execute')}
      </button>
    </form>
  </div>
  
  {executionResult && (
    <div class="execution-result">
      <h3>{t('dynamicworkflow.result')}:</h3>
      <pre>{JSON.stringify(executionResult, null, 2)}</pre>
    </div>
  )}
  
  {executionError && (
    <div class="execution-error">
      <h3>{t('dynamicworkflow.error')}:</h3>
      <p>{executionError}</p>
    </div>
  )}
</div>

<style>
  .workflow-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 1.5rem;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
  }

  .component-wrapper {
    display: flex;
    justify-content: center;
  }

  .unknown-component {
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    color: var(--text-primary);
  }
</style>