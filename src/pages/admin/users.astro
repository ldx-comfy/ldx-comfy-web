---
export const prerender = false;

import Layout from '../../layouts/AdminLayout.astro';
import { requireRolesSSR } from '../../lib/auth/guard';
import { getAllUsers } from '../../api/workflows';

// Guard: require admin role
const cookieHeader = Astro.request.headers.get('cookie');
const guard = await requireRolesSSR(Astro.request.url, cookieHeader, { any: ['admin'] });
if (guard.response) {
  // 403 or redirect to login
  return guard.response;
}
const me = guard.me!;

// Fetch all users
let allUsers: any[] = [];
let usersError: string | null = null;
try {
  allUsers = await getAllUsers({ cookies: cookieHeader || undefined });
} catch (e: any) {
  usersError = e?.message || 'Failed to fetch users list';
}
---

<Layout title="用户管理">
  <!-- 主内容区域 -->
  <main class="admin-main">
      <div class="users-page">
        <h1 class="page-title">用户管理</h1>
        <p class="page-desc">管理用户账户</p>

        {usersError ? (
          <div class="error">{usersError}</div>
        ) : (
          <div class="users-container">
            <div class="users-header">
              <div class="header-left">
                <h3>用户列表</h3>
                <button class="btn primary" id="create-user-btn">创建用户</button>
              </div>
              <div class="search-filter">
                <div class="search-group">
                  <input type="text" id="user-search" placeholder="搜索用户名或邮箱..." class="search-input" />
                  <button class="btn secondary clear-search" id="clear-search">清除</button>
                </div>
                <div class="filter-group">
                  <select id="sort-by" class="filter-select">
                    <option value="username">按用户名排序</option>
                    <option value="created_at">按注册时间</option>
                    <option value="last_login">按最后登录</option>
                    <option value="generation_count">按生成次数</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="users-table-container">
              <table class="users-table">
                <thead>
                  <tr>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>注册时间</th>
                    <th>最后登录</th>
                    <th>生成次数</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  {allUsers.map((user) => (
                    <tr class="user-row" data-user-id={user.id}>
                      <td>{user.username}</td>
                      <td>{user.email}</td>
                      <td>{new Date(user.created_at).toLocaleDateString('zh-CN')}</td>
                      <td>{new Date(user.last_login).toLocaleDateString('zh-CN')}</td>
                      <td>{user.generation_count}</td>
                      <td>
                        <div class="action-buttons">
                          <button class="btn warning reset-password-btn" data-user-id={user.id} data-username={user.username}>重置密码</button>
                          <button class="btn danger delete-user-btn" data-user-id={user.id} data-username={user.username}>删除</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
  </main>
</Layout>

<!-- 创建用户模态框 -->
<div id="create-user-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>创建新用户</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="create-user-form">
        <div class="form-group">
          <label for="new-username">用户名 *</label>
          <input type="text" id="new-username" required />
        </div>
        <div class="form-group">
          <label for="new-password">密码 *</label>
          <input type="password" id="new-password" required minlength="6" />
        </div>
        <div class="form-group">
          <label for="new-email">邮箱</label>
          <input type="email" id="new-email" />
        </div>
        <div class="form-group">
          <label for="new-role">角色</label>
          <select id="new-role">
            <option value="user">普通用户</option>
            <option value="moderator">版主</option>
            <option value="admin">管理员</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" id="cancel-create">取消</button>
      <button class="btn primary" id="confirm-create">创建</button>
    </div>
  </div>
</div>

<!-- 重置密码模态框 -->
<div id="reset-password-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>重置密码</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="reset-password-message"></p>
      <div class="form-group">
        <label for="new-password-input">新密码 *</label>
        <input type="password" id="new-password-input" required minlength="6" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" id="cancel-reset">取消</button>
      <button class="btn primary" id="confirm-reset">重置</button>
    </div>
  </div>
</div>

<!-- 删除用户模态框 -->
<div id="delete-user-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>删除用户</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="delete-user-message"></p>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" id="cancel-delete">取消</button>
      <button class="btn danger" id="confirm-delete">删除</button>
    </div>
  </div>
</div>

<style>
  /* Toast 通知样式 - 绝对定位到浏览器右上角 */
  .toast {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    left: auto !important;
    bottom: auto !important;
    transform: translateY(-20px) scale(0.95) !important;
    background: var(--glass-bg) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
    color: var(--text-primary) !important;
    padding: 16px 20px !important;
    border-radius: 12px !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: 0 8px 25px var(--shadow-light) !important;
    z-index: 999999 !important;
    max-width: 320px !important;
    word-wrap: break-word !important;
    opacity: 0 !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
    font-size: 14px !important;
    font-weight: 500 !important;
  }

  .toast.show {
    /* 覆盖基础样式中的 !important，确保能从透明/位移过渡到可见 */
    opacity: 1 !important;
    transform: translateY(0) scale(1) !important;
  }

  /* Stacking container for multiple toasts */
  .toast-container {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    z-index: 999999 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: flex-end !important;
    gap: 12px !important;
    pointer-events: none !important; /* clicks pass through except on toasts */
  }

  /* When toasts are in the container, remove fixed positioning to allow stacking flow */
  .toast-container .toast {
    position: relative !important;
    top: auto !important;
    right: auto !important;
    left: auto !important;
    bottom: auto !important;
    margin: 0 !important;
    pointer-events: auto !important;
  }

  /* Hide non-visible toasts so they don't occupy space */
  .toast-container .toast:not(.show) {
    position: absolute !important;
    visibility: hidden !important;
  }

  .toast-success {
    background: rgba(76, 175, 80, 0.1);
    border-color: rgba(76, 175, 80, 0.3);
    color: #4caf50;
  }

  .toast-error {
    background: rgba(244, 67, 54, 0.1);
    border-color: rgba(244, 67, 54, 0.3);
    color: #f44336;
  }

  .toast-warning {
    background: rgba(255, 152, 0, 0.1);
    border-color: rgba(255, 152, 0, 0.3);
    color: #ff9800;
  }

  .toast-info {
    background: rgba(33, 150, 243, 0.1);
    border-color: rgba(33, 150, 243, 0.3);
    color: #2196f3;
  }

  .toast-icon {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .toast-icon svg {
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .toast-message {
    flex: 1;
    line-height: 1.4;
  }

  .toast-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    margin: -4px;
    border-radius: 50%;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  .toast-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
    transform: scale(1.1);
  }

  /* Mobile responsiveness for toast */
  @media (max-width: 768px) {
    .toast {
      top: 16px;
      right: 16px;
      left: 16px;
      max-width: none;
      padding: 14px 16px;
      font-size: 13px;
    }
  }

  @media (max-width: 480px) {
    .toast {
      top: 12px;
      right: 12px;
      left: 12px;
      padding: 12px 14px;
    }
  }

  /* Touch device specific styles for toast */
  @media (hover: none) and (pointer: coarse) {
    .toast-close {
      min-width: 32px;
      min-height: 32px;
    }

    .toast-close:active {
      transform: scale(0.95);
    }
  }

  .users-page {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-title {
    margin: 0 0 8px 0;
    font-size: 28px;
    color: var(--text-primary);
    font-weight: 700;
  }

  .page-desc {
    color: var(--text-secondary);
    margin: 0 0 32px 0;
    font-size: 16px;
  }

  .users-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
  }

  .users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .users-header h3 {
    margin: 0;
    font-size: 20px;
    color: var(--text-primary);
  }

  .search-filter {
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-width: 300px;
  }

  .search-group {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .search-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .clear-search {
    padding: 10px 16px;
    white-space: nowrap;
  }

  .filter-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .filter-select {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.9rem;
    min-width: 140px;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--accent-color);
  }

  .filter-select:hover {
    border-color: var(--accent-color);
  }

  .users-table-container {
    overflow-x: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
  }

  .users-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-primary);
  }

  .users-table th,
  .users-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .users-table th {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text-primary);
  }

  .users-table tr:hover {
    background: var(--bg-secondary);
  }


  .btn {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 6px;
    text-decoration: none;
    background: var(--accent-color);
    color: #fff;
    border: 1px solid var(--accent-color);
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .btn.secondary {
    background: transparent;
    color: var(--accent-color);
  }

  .btn:hover {
    opacity: 0.9;
  }

  .error {
    color: #c62828;
    background: #fee;
    border: 1px solid #f44336;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 20px;
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .users-header {
      flex-direction: column;
      gap: 16px;
      align-items: flex-start;
    }

    .search-filter {
      width: 100%;
    }

    .filter-group {
      width: 100%;
    }

    .filter-select {
      flex: 1;
      min-width: 0;
    }

    .users-table-container {
      overflow-x: auto;
    }

    .users-table {
      min-width: 600px;
    }

    .users-table th,
    .users-table td {
      padding: 8px 6px;
      font-size: 0.85rem;
    }

    .modal-content {
      margin: 20px;
      max-width: none;
      width: calc(100% - 40px);
      max-width: 400px;
    }

    .modal-header,
    .modal-body,
    .modal-footer {
      padding: 16px 20px;
    }

    .modal-footer {
      flex-direction: column;
      gap: 8px;
    }

    .modal-footer .btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .admin-main {
      padding: 16px 12px;
    }

    .page-title {
      font-size: 24px;
    }

    .users-container {
      padding: 16px;
    }

    .search-group {
      flex-direction: column;
      gap: 8px;
    }

    .search-input {
      width: 100%;
    }

    .filter-group {
      flex-direction: column;
      gap: 8px;
    }

    .filter-select {
      width: 100%;
    }

    .modal-content {
      margin: 10px;
      width: calc(100% - 20px);
      max-width: 350px;
    }

    .modal-header,
    .modal-body,
    .modal-footer {
      padding: 12px 16px;
    }

    .modal-header h3 {
      font-size: 1rem;
    }

    .modal-body input,
    .modal-body select {
      padding: 6px 10px;
      font-size: 0.85rem;
    }

    .modal-footer .btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      min-width: 60px;
    }
    }
  
    /* 操作按钮样式 */
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
  
    .action-buttons .btn {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
  
    .btn.warning {
      background: #ffc107;
      color: #212529;
      border-color: #ffc107;
    }
  
    .btn.warning:hover {
      background: #e0a800;
    }
  
    /* 模态框样式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
  
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
  
    .modal-content {
      background: var(--bg-primary);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
    }
  
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
    }
  
    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.1rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.3;
    }
  
    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
  
    .modal-close:hover {
      background-color: var(--bg-secondary);
    }
  
    .modal-body {
      padding: 20px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
  
    .modal-body p {
      word-wrap: break-word;
      overflow-wrap: break-word;
      margin: 0 0 16px 0;
      line-height: 1.5;
    }
  
    .modal-body .form-group {
      margin-bottom: 16px;
    }
  
    .modal-body .form-group:last-child {
      margin-bottom: 0;
    }
  
    .modal-body label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }
  
    .modal-body input,
    .modal-body select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.9rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
      min-width: 0; /* 防止flex子项超出容器 */
      word-wrap: break-word;
    }
  
    .modal-body input[type="password"],
    .modal-body input[type="email"],
    .modal-body input[type="text"] {
      max-width: 100%;
    }
  
    .modal-body input:focus,
    .modal-body select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
  
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
    }
  
    .modal-footer .btn {
      min-width: 70px;
      padding: 8px 16px;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>

  <style is:global>
    /* Global Toast baseline styles for dynamic toasts on this page */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--glass-bg, rgba(255, 255, 255, 0.85));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text-primary, #111);
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--border-color, rgba(0,0,0,0.1));
      box-shadow: 0 8px 25px var(--shadow-light, rgba(0,0,0,0.12));
      z-index: 999999;
      max-width: 320px;
      word-wrap: break-word;
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px;
      font-weight: 500;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .toast-success { background: rgba(76, 175, 80, 0.1); border-color: rgba(76,175,80,0.3); color: #4caf50; }
    .toast-error { background: rgba(244, 67, 54, 0.1); border-color: rgba(244, 67, 54, 0.3); color: #f44336; }
    .toast-warning { background: rgba(255, 152, 0, 0.1); border-color: rgba(255,152,0,0.3); color: #ff9800; }
    .toast-info { background: rgba(33,150,243,0.1); border-color: rgba(33,150,243,0.3); color: #2196f3; }

    .toast-icon { flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .toast-icon svg { stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .toast-message { flex: 1; line-height: 1.4; }

    .toast-close {
      background: none; border: none; color: var(--text-secondary, #666);
      font-size: 20px; cursor: pointer; padding: 4px; margin: -4px;
      border-radius: 50%; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
      width: 24px; height: 24px; flex-shrink: 0;
    }
    .toast-close:hover { background: var(--bg-secondary, rgba(0,0,0,0.04)); color: var(--text-primary, #111); transform: scale(1.1); }

    /* Stacking container (global) */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999999;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
      pointer-events: none;
    }
    .toast-container .toast {
      position: relative;
      top: auto;
      right: auto;
      left: auto;
      bottom: auto;
      margin: 0;
      pointer-events: auto;
    }
    .toast-container .toast:not(.show) {
      position: absolute;
      visibility: hidden;
    }
  </style>

<script>
  // Import the required functions
  import { createUser, deleteUser, resetUserPassword } from '../../api/workflows';

  // 辅助函数 - 使用 Toast 组件进行通知（支持堆叠）
  function ensureToastContainer(): HTMLElement {
    let el = document.getElementById('toast-container') as HTMLElement | null;
    if (!el) {
      el = document.createElement('div');
      el.id = 'toast-container';
      el.className = 'toast-container';
      document.body.appendChild(el);
    }
    return el;
  }

  function showToast(message: string, type: 'success' | 'error' | 'warning' | 'info' = 'info', duration: number = 3000) {
    // 创建 toast 元素
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-icon">
        ${type === 'success' ? `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        ` : type === 'error' ? `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        ` : type === 'warning' ? `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        ` : `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `}
      </div>
      <span class="toast-message">${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
    `;

    // 追加到堆叠容器
    const container = ensureToastContainer();
    container.appendChild(toast);

    // 显示动画
    window.setTimeout(() => toast.classList.add('show'), 10);

    // 自动关闭
    window.setTimeout(() => {
      toast.classList.remove('show');
      window.setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 400);
    }, duration);
  }

  // 用户管理功能
  // 用户搜索和过滤
  const userSearchInput = document.getElementById('user-search') as HTMLInputElement;
  const sortBySelect = document.getElementById('sort-by') as HTMLSelectElement;
  const clearSearchBtn = document.getElementById('clear-search') as HTMLButtonElement;

  function filterUsers() {
    const searchTerm = userSearchInput?.value.toLowerCase().trim() || '';

    const userRows = document.querySelectorAll('.user-row');
    let visibleCount = 0;

    userRows.forEach(row => {
      const username = row.querySelector('td:first-child')?.textContent?.toLowerCase() || '';
      const email = row.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';

      const matchesSearch = !searchTerm ||
        username.includes(searchTerm) ||
        email.includes(searchTerm);

      if (matchesSearch) {
        (row as HTMLElement).style.display = '';
        visibleCount++;
      } else {
        (row as HTMLElement).style.display = 'none';
      }
    });

    // 显示过滤结果统计
    updateFilterStats(visibleCount, userRows.length);
  }

  function sortUsers() {
    const sortBy = sortBySelect?.value || 'username';
    const userTableBody = document.querySelector('.users-table tbody') as HTMLTableSectionElement;

    if (!userTableBody) return;

    const userRows = Array.from(userTableBody.querySelectorAll('.user-row'));

    userRows.sort((a, b) => {
      let aValue: string | number = '';
      let bValue: string | number = '';

      switch (sortBy) {
        case 'username':
          aValue = a.querySelector('td:first-child')?.textContent || '';
          bValue = b.querySelector('td:first-child')?.textContent || '';
          break;
        case 'created_at':
          aValue = new Date(a.querySelector('td:nth-child(5)')?.textContent || '').getTime();
          bValue = new Date(b.querySelector('td:nth-child(5)')?.textContent || '').getTime();
          break;
        case 'last_login':
          aValue = new Date(a.querySelector('td:nth-child(6)')?.textContent || '').getTime();
          bValue = new Date(b.querySelector('td:nth-child(6)')?.textContent || '').getTime();
          break;
        case 'generation_count':
          aValue = parseInt(a.querySelector('td:nth-child(7)')?.textContent || '0');
          bValue = parseInt(b.querySelector('td:nth-child(7)')?.textContent || '0');
          break;
      }

      if (typeof aValue === 'string' && typeof bValue === 'string') {
        return aValue.localeCompare(bValue);
      }

      return (aValue as number) - (bValue as number);
    });

    // 重新插入排序后的行
    userRows.forEach(row => {
      userTableBody.appendChild(row);
    });
  }

  function updateFilterStats(visible: number, total: number) {
    // 可以在这里添加显示过滤统计的代码
    console.log(`显示 ${visible} / ${total} 个用户`);
  }

  function clearSearch() {
    userSearchInput.value = '';
    filterUsers();
  }

  // 事件监听器
  userSearchInput?.addEventListener('input', filterUsers);
  sortBySelect?.addEventListener('change', sortUsers);
  clearSearchBtn?.addEventListener('click', clearSearch);

  // 防抖搜索
  let searchTimeout: number;
  userSearchInput?.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = window.setTimeout(filterUsers, 300);
  });

  // 创建用户功能

  // 创建用户功能
  const createUserBtn = document.getElementById('create-user-btn') as HTMLButtonElement;
  const createUserModal = document.getElementById('create-user-modal') as HTMLDivElement;
  const createUserForm = document.getElementById('create-user-form') as HTMLFormElement;
  const cancelCreateBtn = document.getElementById('cancel-create') as HTMLButtonElement;
  const confirmCreateBtn = document.getElementById('confirm-create') as HTMLButtonElement;

  function showCreateUserModal() {
    if (createUserForm) createUserForm.reset();
    if (createUserModal) createUserModal.classList.add('show');
  }

  function hideCreateUserModal() {
    if (createUserModal) createUserModal.classList.remove('show');
  }

  createUserBtn?.addEventListener('click', showCreateUserModal);
  cancelCreateBtn?.addEventListener('click', hideCreateUserModal);

  createUserModal?.querySelector('.modal-close')?.addEventListener('click', hideCreateUserModal);

  // 点击模态框外部关闭
  createUserModal?.addEventListener('click', (e) => {
    if (e.target === createUserModal) {
      hideCreateUserModal();
    }
  });

  confirmCreateBtn?.addEventListener('click', async () => {
    const username = (document.getElementById('new-username') as HTMLInputElement)?.value.trim();
    const password = (document.getElementById('new-password') as HTMLInputElement)?.value;
    const email = (document.getElementById('new-email') as HTMLInputElement)?.value.trim();
    const role = (document.getElementById('new-role') as HTMLSelectElement)?.value;

    if (!username || !password) {
      showToast('用户名和密码不能为空', 'error');
      return;
    }

    if (password.length < 6) {
      showToast('密码长度至少为6位', 'error');
      return;
    }

    try {
      const result = await createUser({
        username,
        password,
        email: email || `${username}@example.com`,
        role
      });

      showToast('用户创建成功', 'success');
      hideCreateUserModal();

      // 刷新页面以显示新用户
      setTimeout(() => {
        location.reload();
      }, 1000);
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : '创建用户失败';
      showToast(`创建失败: ${errorMessage}`, 'error');
    }
  });

  // 删除用户功能
  document.querySelectorAll('.delete-user-btn').forEach(button => {
    button.addEventListener('click', async function(this: HTMLButtonElement) {
      const userId = this.getAttribute('data-user-id');
      const username = this.getAttribute('data-username');

      if (!userId || !username) return;

      // 更新删除模态框的内容
      const deleteMessage = document.getElementById('delete-user-message');
      if (deleteMessage) {
        deleteMessage.textContent = `确定要删除用户 "${username}" 吗？此操作不可撤销。`;
      }

      const deleteModal = document.getElementById('delete-user-modal');
      deleteModal?.classList.add('show');

      // 设置确认删除按钮的事件
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');

      const handleConfirm = async () => {
        try {
          await deleteUser(userId);
          showToast('用户删除成功', 'success');
          deleteModal?.classList.remove('show');

          // 从表格中移除用户行
          const userRow = document.querySelector(`.user-row[data-user-id="${userId}"]`);
          userRow?.remove();
        } catch (error: unknown) {
          const errorMessage = error instanceof Error ? error.message : '删除用户失败';
          showToast(`删除失败: ${errorMessage}`, 'error');
        }
      };

      const handleCancel = () => {
        deleteModal?.classList.remove('show');
      };

      // 移除之前的事件监听器
      confirmDeleteBtn?.removeEventListener('click', handleConfirm);
      cancelDeleteBtn?.removeEventListener('click', handleCancel);

      // 添加新的事件监听器
      confirmDeleteBtn?.addEventListener('click', handleConfirm);
      cancelDeleteBtn?.addEventListener('click', handleCancel);

      // 关闭按钮
      deleteModal?.querySelector('.modal-close')?.addEventListener('click', handleCancel);

      // 点击模态框外部关闭
      deleteModal?.addEventListener('click', (e) => {
        if (e.target === deleteModal) {
          handleCancel();
        }
      });
    });
  });

  // 重置密码功能
  document.querySelectorAll('.reset-password-btn').forEach(button => {
    button.addEventListener('click', async function(this: HTMLButtonElement) {
      const userId = this.getAttribute('data-user-id');
      const username = this.getAttribute('data-username');

      if (!userId || !username) return;

      // 更新重置密码模态框的内容
      const resetMessage = document.getElementById('reset-password-message');
      if (resetMessage) {
        resetMessage.textContent = `为用户 "${username}" 设置新密码：`;
      }

      const resetModal = document.getElementById('reset-password-modal');
      const passwordInput = document.getElementById('new-password-input') as HTMLInputElement;
      resetModal?.classList.add('show');

      // 清空密码输入框
      if (passwordInput) {
        passwordInput.value = '';
        passwordInput.focus();
      }

      // 设置确认重置按钮的事件
      const confirmResetBtn = document.getElementById('confirm-reset');
      const cancelResetBtn = document.getElementById('cancel-reset');

      const handleConfirm = async () => {
        const newPassword = passwordInput?.value;

        if (!newPassword || newPassword.length < 6) {
          showToast('密码长度至少为6位', 'error');
          return;
        }

        try {
          await resetUserPassword(userId, newPassword);
          showToast('密码重置成功', 'success');
          resetModal?.classList.remove('show');
        } catch (error: unknown) {
          const errorMessage = error instanceof Error ? error.message : '重置密码失败';
          showToast(`重置失败: ${errorMessage}`, 'error');
        }
      };

      const handleCancel = () => {
        resetModal?.classList.remove('show');
      };

      // 移除之前的事件监听器
      confirmResetBtn?.removeEventListener('click', handleConfirm);
      cancelResetBtn?.removeEventListener('click', handleCancel);

      // 添加新的事件监听器
      confirmResetBtn?.addEventListener('click', handleConfirm);
      cancelResetBtn?.addEventListener('click', handleCancel);

      // 关闭按钮
      resetModal?.querySelector('.modal-close')?.addEventListener('click', handleCancel);

      // 点击模态框外部关闭
      resetModal?.addEventListener('click', (e) => {
        if (e.target === resetModal) {
          handleCancel();
        }
      });
    });
  });

</script>