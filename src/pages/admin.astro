---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { getTranslator } from '@gudupao/astro-i18n';
import { requireRolesSSR } from '../lib/auth/guard';
import { pingAdmin } from '../lib/auth/service';
import { getAllUsersGenerationHistory, getWorkflowList, uploadWorkflow, deleteWorkflow } from '../api/workflows';
import { toBackendAbsoluteUrl } from '../lib/api/client';
import CanCmp from '../components/Can.astro';

// i18n
const lang = Astro.params.lang || Astro.cookies.get('lang')?.value || 'en';
const t = getTranslator(lang);

// Guard: require admin role
const cookieHeader = Astro.request.headers.get('cookie');
const guard = await requireRolesSSR(Astro.request.url, cookieHeader, { any: ['admin'] });
if (guard.response) {
  // 403 or redirect to login
  return guard.response;
}
const me = guard.me!;

// Optionally call protected endpoint to validate
let pingResult: { ok?: boolean; sub?: string } | null = null;
let pingError: string | null = null;
try {
  pingResult = await pingAdmin({ cookies: cookieHeader || undefined });
} catch (e: any) {
  pingError = e?.message || 'Failed to call admin ping';
}

// Fetch all users' generation history
let allUsersHistory: Record<string, any>[] = [];
let historyError: string | null = null;
try {
  allUsersHistory = await getAllUsersGenerationHistory({ cookies: cookieHeader || undefined });
} catch (e: any) {
  historyError = e?.message || 'Failed to fetch all users history';
}

// Fetch workflow list
let workflowList: string[] = [];
let workflowError: string | null = null;
try {
  workflowList = await getWorkflowList({ cookies: cookieHeader || undefined });
} catch (e: any) {
  workflowError = e?.message || 'Failed to fetch workflow list';
}
---

<Layout title={t('admin.title')}>
  <div class="admin-page">
    <h1 class="title">{t('admin.title')}</h1>
    <p class="desc">{t('admin.description')}</p>

    <div class="card">
      <h3>{t('admin.currentIdentity')}</h3>
      <pre class="json">{JSON.stringify(me, null, 2)}</pre>
    </div>

    <div class="card">
      <h3>{t('admin.protectedApiValidation')}</h3>
      {pingError ? (
        <div class="error">{t('admin.apiCallFailed', { error: pingError })}</div>
      ) : (
        <pre class="json">{JSON.stringify(pingResult, null, 2)}</pre>
      )}
    </div>

    <div class="rbac-demo">
      <h3>{t('admin.rbacDemo')}</h3>
      <CanCmp me={me} rolesAny={['admin']} elseText={t('admin.notAdminMessage')}>
        <div class="admin-only">
          <strong>{t('admin.adminOnlySection')}</strong> {t('admin.rbacControlledContent')}
        </div>
      </CanCmp>
    </div>

    <div class="actions">
      <a class="btn secondary" href="/">{t('admin.backToHome')}</a>
      <a class="btn" href="/logout?next=/admin">{t('admin.logout')}</a>
    </div>
    
    <div class="section">
      <h2>{t('admin.allUsersGenerationHistory')}</h2>
      {historyError ? (
        <div class="error">{historyError}</div>
      ) : (
        <div class="card history-container">
          {allUsersHistory.length > 0 ? (
            <div class="history-grid">
              {allUsersHistory.map((record) => {
                const images = (record.result && record.result.images) || [];
                const firstImage = images.length > 0 ? images[0] : null;
                // Handle both base64 data URLs and file paths
                let imageUrl = null;
                if (firstImage) {
                  if (firstImage.startsWith('data:')) {
                    // Base64 data URL
                    imageUrl = firstImage;
                  } else if (firstImage.startsWith('/comfy_out_image/')) {
                    // File path with prefix
                    imageUrl = toBackendAbsoluteUrl(firstImage);
                  } else {
                    // File path without prefix
                    imageUrl = toBackendAbsoluteUrl(`/comfy_out_image/${firstImage}`);
                  }
                }
                
                return (
                  <div class="history-item">
                    <div class="history-header">
                      <span class="execution-id">{t('admin.executionId')}: {record.execution_id}</span>
                      <span class="workflow-id">{t('admin.workflow')}: {record.workflow_id}</span>
                      <span class="user-id">{t('admin.userId')}: {record.user_id}</span>
                    </div>
                    <div class="history-content">
                      {imageUrl ? (
                        <div class="image-container">
                          <img
                            src={imageUrl}
                            alt="生成結果"
                            class="history-image"
                          />
                        </div>
                      ) : (
                        <div class="no-image">{t('admin.noImage')}</div>
                      )}
                      <div class="history-details">
                        <div class="timestamp">{t('admin.time')}: {new Date(record.timestamp * 1000).toLocaleString(lang)}</div>
                        <div class="images-count">{t('admin.imagesCount')}: {images.length}</div>
                      </div>
                      <div class="history-actions">
                        <a href={`/admin/history/${record.execution_id}`} class="btn secondary">{t('history.viewDetails')}</a>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <p>{t('admin.noHistory')}</p>
          )}
        </div>
      )}
    </div>
    
    <div class="section">
      <h2>{t('admin.workflowManagement')}</h2>
      {workflowError ? (
        <div class="error">{workflowError}</div>
      ) : (
        <div class="card workflow-container">
          {/* Upload workflow form */}
          <div class="upload-section">
            <h3>{t('admin.uploadWorkflow')}</h3>
            <form id="upload-form" class="upload-form">
              <input type="file" id="workflow-file" accept=".json" required />
              <button type="submit" class="btn">{t('admin.upload')}</button>
            </form>
            <div id="upload-message" class="message"></div>
          </div>
          
          {/* Workflow list */}
          <div class="workflow-list">
            <h3>{t('admin.workflowList')}</h3>
            {workflowList.length > 0 ? (
              <ul class="workflow-grid">
                {workflowList.map((workflowId) => (
                  <li class="workflow-item" data-workflow-id={workflowId}>
                    <span class="workflow-id">{workflowId}</span>
                    <button class="btn secondary delete-btn" data-workflow-id={workflowId}>
                      {t('admin.delete')}
                    </button>
                  </li>
                ))}
              </ul>
            ) : (
              <p>{t('admin.noWorkflows')}</p>
            )}
          </div>
        </div>
      )}
    </div>
  </div>
</Layout>

<style>
  .admin-page { display: flex; flex-direction: column; gap: 16px; }
  .title { margin: 0; font-size: 24px; color: var(--text-primary); }
  .desc { color: var(--text-secondary); margin: 0 0 8px 0; }
  .card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
  }
  .json { margin: 0; white-space: pre-wrap; word-break: break-word; color: var(--text-primary); font-size: 0.9rem; }
  .error { color: #c62828; background: #fee; border: 1px solid #f44336; border-radius: 8px; padding: 10px 12px; }
  .rbac-demo { margin-top: 8px; }
  .admin-only { margin-top: 8px; padding: 10px 12px; background: rgba(59,130,246,0.1); border: 1px solid var(--accent-color); border-radius: 8px; }
  .actions { display: flex; gap: 10px; }
  .btn { display: inline-block; padding: 10px 12px; border-radius: 8px; text-decoration: none; background: var(--accent-color); color: #fff; border: 1px solid var(--accent-color); }
  .btn.secondary { background: transparent; color: var(--accent-color); }
  
  /* History styles */
  .history-container {
    padding: 0;
  }
  
  .history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    padding: 16px;
  }
  
  .history-item {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .history-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }
  
  .history-header {
    padding: 12px;
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-color);
  }
  
  .execution-id, .workflow-id, .user-id {
    display: block;
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .history-content {
    padding: 12px;
  }
  
  .image-container {
    width: 100%;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border-radius: 8px;
    background: var(--bg-primary);
    margin-bottom: 12px;
  }
  
  .history-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  
  .no-image {
    width: 100%;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    font-style: italic;
  }
  
  .history-details {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }
  
  .timestamp, .images-count {
    margin-bottom: 4px;
  }
  
  /* Workflow management styles */
  .workflow-container {
    padding: 16px;
  }
  
  .upload-section {
    margin-bottom: 24px;
  }
  
  .upload-form {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .workflow-list {
    margin-top: 24px;
  }
  
  .workflow-grid {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .workflow-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 8px;
    background: var(--bg-primary);
  }
  
  .workflow-id {
    font-weight: 500;
  }
  
  .message {
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
  }
  
  .message.success {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #4caf50;
  }
  
  .message.error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #f44336;
  }
</style>

<script>
  // Import the required functions directly in the client script
  import { uploadWorkflow, deleteWorkflow } from '../api/workflows';

  // Handle workflow upload
  document.getElementById('upload-form')?.addEventListener('submit', async function(e: Event) {
    e.preventDefault();
    
    const fileInput = document.getElementById('workflow-file') as HTMLInputElement | null;
    const messageDiv = document.getElementById('upload-message') as HTMLDivElement | null;
    
    if (!fileInput || !fileInput.files || !fileInput.files.length) {
      if (messageDiv) {
        messageDiv.textContent = '請選擇一個文件';
        messageDiv.className = 'message error';
      }
      return;
    }
    
    const file = fileInput.files[0];
    
    try {
      // Call the uploadWorkflow API function
      const result = await uploadWorkflow(file);
      
      // Show success message
      if (messageDiv) {
        messageDiv.textContent = result.message;
        messageDiv.className = 'message success';
      }
      
      // Clear the file input
      fileInput.value = '';
      
      // Refresh the page to show the updated workflow list
      location.reload();
    } catch (error: unknown) {
      // Show error message
      if (messageDiv) {
        const errorMessage = error instanceof Error ? error.message : '上傳失敗';
        messageDiv.textContent = errorMessage;
        messageDiv.className = 'message error';
      }
    }
  });
  
  // Handle workflow deletion
  document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', async function(this: HTMLButtonElement) {
      const workflowId = this.getAttribute('data-workflow-id');
      const workflowItem = this.closest('.workflow-item');
      const messageDiv = document.getElementById('upload-message') as HTMLDivElement | null;
      
      if (!workflowId) {
        if (messageDiv) {
          messageDiv.textContent = '工作流ID缺失';
          messageDiv.className = 'message error';
        }
        return;
      }
      
      // Confirm deletion
      if (!confirm(`確定要刪除工作流 "${workflowId}" 嗎？`)) {
        return;
      }
      
      try {
        // Call the deleteWorkflow API function
        const result = await deleteWorkflow(workflowId);
        
        // Show success message
        if (messageDiv) {
          messageDiv.textContent = result.message;
          messageDiv.className = 'message success';
        }
        
        // Remove the workflow item from the list
        if (workflowItem) {
          workflowItem.remove();
        }
      } catch (error: unknown) {
        // Show error message
        if (messageDiv) {
          const errorMessage = error instanceof Error ? error.message : '刪除失敗';
          messageDiv.textContent = errorMessage;
          messageDiv.className = 'message error';
        }
      }
    });
  });
</script>