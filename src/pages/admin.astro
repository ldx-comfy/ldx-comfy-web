---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { getTranslator } from '@gudupao/astro-i18n';
import { requireRolesSSR } from '../lib/auth/guard';
import { pingAdmin } from '../lib/auth/service';
import CanCmp from '../components/Can.astro';

// i18n
const lang = Astro.params.lang || Astro.cookies.get('lang')?.value || 'en';
const t = getTranslator(lang);

// Guard: require admin role
const cookieHeader = Astro.request.headers.get('cookie');
const guard = await requireRolesSSR(Astro.request.url, cookieHeader, { any: ['admin'] });
if (guard.response) {
  // 403 or redirect to login
  return guard.response;
}
const me = guard.me!;

// Optionally call protected endpoint to validate
let pingResult: { ok?: boolean; sub?: string } | null = null;
let pingError: string | null = null;
try {
  pingResult = await pingAdmin({ cookies: cookieHeader || undefined });
} catch (e: any) {
  pingError = e?.message || 'Failed to call admin ping';
}
---

<Layout title={t('admin.title')}>
  <div class="admin-page">
    <h1 class="title">{t('admin.title')}</h1>
    <p class="desc">{t('admin.description')}</p>

    <div class="card">
      <h3>{t('admin.currentIdentity')}</h3>
      <pre class="json">{JSON.stringify(me, null, 2)}</pre>
    </div>

    <div class="card">
      <h3>{t('admin.protectedApiValidation')}</h3>
      {pingError ? (
        <div class="error">{t('admin.apiCallFailed', { error: pingError })}</div>
      ) : (
        <pre class="json">{JSON.stringify(pingResult, null, 2)}</pre>
      )}
    </div>

    <div class="rbac-demo">
      <h3>{t('admin.rbacDemo')}</h3>
      <CanCmp me={me} rolesAny={['admin']} elseText={t('admin.notAdminMessage')}>
        <div class="admin-only">
          <strong>{t('admin.adminOnlySection')}</strong> {t('admin.rbacControlledContent')}
        </div>
      </CanCmp>
    </div>

    <div class="actions">
      <a class="btn secondary" href="/">{t('admin.backToHome')}</a>
      <a class="btn" href="/logout?next=/admin">{t('admin.logout')}</a>
    </div>
  </div>
</Layout>

<style>
  .admin-page { display: flex; flex-direction: column; gap: 16px; }
  .title { margin: 0; font-size: 24px; color: var(--text-primary); }
  .desc { color: var(--text-secondary); margin: 0 0 8px 0; }
  .card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
  }
  .json { margin: 0; white-space: pre-wrap; word-break: break-word; color: var(--text-primary); font-size: 0.9rem; }
  .error { color: #c62828; background: #fee; border: 1px solid #f44336; border-radius: 8px; padding: 10px 12px; }
  .rbac-demo { margin-top: 8px; }
  .admin-only { margin-top: 8px; padding: 10px 12px; background: rgba(59,130,246,0.1); border: 1px solid var(--accent-color); border-radius: 8px; }
  .actions { display: flex; gap: 10px; }
  .btn { display: inline-block; padding: 10px 12px; border-radius: 8px; text-decoration: none; background: var(--accent-color); color: #fff; border: 1px solid var(--accent-color); }
  .btn.secondary { background: transparent; color: var(--accent-color); }
</style>