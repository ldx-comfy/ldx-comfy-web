---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { getTranslator } from '@gudupao/astro-i18n';
import { ensureMeSSR } from '../lib/auth/guard';
import { getUserWorkflows, getUserGenerationHistory } from '../api/workflows';
import { resetOwnPassword } from '../lib/auth/service';
import { toBackendAbsoluteUrl } from '../lib/api/client';


// i18n
const lang = Astro.params.lang || Astro.cookies.get('lang')?.value || 'en';
const t = getTranslator(lang);

// Guard: require logged-in and fetch claims
const cookieHeader = Astro.request.headers.get('cookie');
const guard = await ensureMeSSR(Astro.request.url, cookieHeader);
if (guard.response) {
  // Not logged in or token invalid -> redirect to login
  return guard.response;
}
const me = guard.me!;

const tokenRemainingText = (() => {
  const nowSec = Math.floor(Date.now() / 1000);
  const rem = (me.exp || 0) - nowSec;
  if (rem <= 0) return t('me.tokenExpired') || '已过期';
  const d = Math.floor(rem / 86400);
  const h = Math.floor((rem % 86400) / 3600);
  const m = Math.floor((rem % 3600) / 60);
  return `${d > 0 ? d + '天 ' : ''}${h}时 ${m}分`;
})();


 // Fetch user history
const userHistory = await getUserGenerationHistory({ cookies: cookieHeader || undefined });

// Handle password reset form submission
let resetMessage = '';
let resetError = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const method = formData.get('_method')?.toString(); // 讀取隱藏欄位 _method

  if (method === 'PUT') {
    const currentPassword = formData.get('current_password')?.toString() || '';
    const newPassword = formData.get('new_password')?.toString() || '';
    const confirmPassword = formData.get('confirm_password')?.toString() || '';
    
    // Validate passwords
    if (!currentPassword || !newPassword || !confirmPassword) {
      resetError = '所有字段都是必填的';
    } else if (newPassword !== confirmPassword) {
      resetError = '新密碼和確認密碼不匹配';
    } else if (newPassword.length < 6) {
      resetError = '新密碼長度至少為6位';
    } else {
      try {
        // Reset password
        await resetOwnPassword(currentPassword, newPassword, { cookies: cookieHeader || undefined });
        resetMessage = '密碼重置成功';
        resetError = '';
      } catch (error) {
        console.error('密碼重置失敗:', error);
        resetError = error instanceof Error ? error.message : '密碼重置失敗';
        resetMessage = '';
      }
    }
  }
}
---

<Layout title={t('me.title')}>
  <div class="me-page">
    <h1 class="title">{t('me.title')}</h1>
    
    <div class="section">
      <h2>{t('me.userInfo')}</h2>
      <div class="card user-info-card">
        <div class="user-main">
          <div class="avatar" aria-hidden="true">
            {((me?.sub && me.sub[0]) || '?').toUpperCase()}
          </div>
          <div class="user-meta">
            <div class="user-row"><strong>{t('me.username') || '用户名'}:</strong> {me.sub}</div>
            <div class="user-row"><strong>{t('me.loginMode') || '登录方式'}:</strong> {me.login_mode}</div>
            <div class="user-row"><strong>{t('me.roles') || '角色'}:</strong> {(me.roles || []).length > 0 ? (me.roles || []).map((r) => <span class="badge">{r}</span>) : <span class="muted">{t('me.noRoles') || '无角色'}</span>}</div>
            <div class="user-row"><strong>{t('me.groups') || '群组'}:</strong> {(me.groups || []).length > 0 ? (me.groups || []).join(', ') : <span class="muted">{t('me.noGroups') || '无群组'}</span>}</div>
            <div class="user-row"><strong>{t('me.permissions') || '权限'}:</strong> {(me.permissions || []).length > 0 ? (me.permissions || []).join(', ') : <span class="muted">{t('me.noPermissions') || '无权限'}</span>}</div>
          </div>
        </div>

        <div class="token-info">
          <div><strong>{t('me.issuedAt') || '签发时间'}:</strong> {new Date((me.iat || 0) * 1000).toLocaleString(lang)}</div>
          <div><strong>{t('me.expiresAt') || '失效时间'}:</strong> {new Date((me.exp || 0) * 1000).toLocaleString(lang)}</div>
          <div><strong>{t('me.tokenExpiresIn') || '剩余'}:</strong> {tokenRemainingText}</div>
        </div>

      </div>
    </div>
    
    
    <div class="section">
      <h2>{t('history.title')}</h2>
      <div class="card history-container">
        {userHistory.length > 0 ? (
          <div class="history-grid">
            {userHistory.map((record) => {
              const images = (record.result && record.result.images) || [];
              const firstImage = images.length > 0 ? images[0] : null;
              // Handle both base64 data URLs and file paths
              let imageUrl = null;
              if (firstImage) {
                if (firstImage.startsWith('data:')) {
                  // Base64 data URL
                  imageUrl = firstImage;
                } else {
                  // File path without prefix
                  imageUrl = toBackendAbsoluteUrl(`/comfy_out_image/${firstImage}`);
                }
              }
              
              // Format timestamp based on language
              const formatDate = (timestamp: number) => {
                const date = new Date(timestamp * 1000);
                const now = new Date();
                const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
                
                // Define time units in seconds
                const minute = 60;
                const hour = minute * 60;
                const day = hour * 24;
                const week = day * 7;
                const month = day * 30;
                const year = day * 365;
                
                // Get language-specific translations
                const translations = {
                  'en': {
                    'just now': 'just now',
                    'seconds ago': 'seconds ago',
                    'a minute ago': 'a minute ago',
                    'minutes ago': 'minutes ago',
                    'an hour ago': 'an hour ago',
                    'hours ago': 'hours ago',
                    'a day ago': 'a day ago',
                    'days ago': 'days ago',
                    'a week ago': 'a week ago',
                    'weeks ago': 'weeks ago',
                    'a month ago': 'a month ago',
                    'months ago': 'months ago',
                    'a year ago': 'a year ago',
                    'years ago': 'years ago'
                  },
                  'cn': {
                    'just now': '剛剛',
                    'seconds ago': '秒前',
                    'a minute ago': '1 分鐘前',
                    'minutes ago': '分鐘前',
                    'an hour ago': '1 小時前',
                    'hours ago': '小時前',
                    'a day ago': '1 天前',
                    'days ago': '天前',
                    'a week ago': '1 周前',
                    'weeks ago': '周前',
                    'a month ago': '1 個月前',
                    'months ago': '個月前',
                    'a year ago': '1 年前',
                    'years ago': '年前'
                  },
                  'hk': {
                    'just now': '剛剛',
                    'seconds ago': '秒前',
                    'a minute ago': '1 分鐘前',
                    'minutes ago': '分鐘前',
                    'an hour ago': '1 小時前',
                    'hours ago': '小時前',
                    'a day ago': '1 天前',
                    'days ago': '天前',
                    'a week ago': '1 週前',
                    'weeks ago': '週前',
                    'a month ago': '1 個月前',
                    'months ago': '個月前',
                    'a year ago': '1 年前',
                    'years ago': '年前'
                  },
                  'fr': {
                    'just now': 'à l\'instant',
                    'seconds ago': 'secondes ago',
                    'a minute ago': 'une minute ago',
                    'minutes ago': 'minutes ago',
                    'an hour ago': 'une heure ago',
                    'hours ago': 'heures ago',
                    'a day ago': 'un jour ago',
                    'days ago': 'jours ago',
                    'a week ago': 'une semaine ago',
                    'weeks ago': 'semaines ago',
                    'a month ago': 'un mois ago',
                    'months ago': 'mois ago',
                    'a year ago': 'un an ago',
                    'years ago': 'ans ago'
                  },
                  'jp': {
                    'just now': 'たった今',
                    'seconds ago': '秒前',
                    'a minute ago': '1 分前',
                    'minutes ago': '分前',
                    'an hour ago': '1 時間前',
                    'hours ago': '時間前',
                    'a day ago': '1 日前',
                    'days ago': '日前',
                    'a week ago': '1 週間前',
                    'weeks ago': '週間前',
                    'a month ago': '1 ヶ月前',
                    'months ago': 'ヶ月前',
                    'a year ago': '1 年前',
                    'years ago': '年前'
                  }
                };
                
                // Get translations for current language, fallback to English
                const t = translations[lang as keyof typeof translations] || translations['en'];
                
                if (diffInSeconds < 5) {
                  return t['just now'];
                } else if (diffInSeconds < minute) {
                  return `${diffInSeconds} ${t['seconds ago']}`;
                } else if (diffInSeconds < 2 * minute) {
                  return t['a minute ago'];
                } else if (diffInSeconds < hour) {
                  return `${Math.floor(diffInSeconds / minute)} ${t['minutes ago']}`;
                } else if (diffInSeconds < 2 * hour) {
                  return t['an hour ago'];
                } else if (diffInSeconds < day) {
                  return `${Math.floor(diffInSeconds / hour)} ${t['hours ago']}`;
                } else if (diffInSeconds < 2 * day) {
                  return t['a day ago'];
                } else if (diffInSeconds < week) {
                  return `${Math.floor(diffInSeconds / day)} ${t['days ago']}`;
                } else if (diffInSeconds < 2 * week) {
                  return t['a week ago'];
                } else if (diffInSeconds < month) {
                  return `${Math.floor(diffInSeconds / week)} ${t['weeks ago']}`;
                } else if (diffInSeconds < 2 * month) {
                  return t['a month ago'];
                } else if (diffInSeconds < year) {
                  return `${Math.floor(diffInSeconds / month)} ${t['months ago']}`;
                } else if (diffInSeconds < 2 * year) {
                  return t['a year ago'];
                } else {
                  return `${Math.floor(diffInSeconds / year)} ${t['years ago']}`;
                }
              };
              
              return (
                <div class="history-item">
                  <div class="history-header">
                    <span class="execution-id">{t('history.executionId')}: {record.execution_id}</span>
                    <span class="workflow-id">{t('history.workflow')}: {record.workflow_id}</span>
                  </div>
                  <div class="history-content">
                    {imageUrl ? (
                      <div class="image-container">
                        <img
                          src={imageUrl}
                          alt={t('dynamicworkflow.result')}
                          class="history-image"
                          data-preview-src={imageUrl}
                          data-execution-id={record.execution_id}
                        />
                      </div>
                    ) : (
                      <div class="no-image">{t('history.noImage')}</div>
                    )}
                    <div class="history-details">
                      <div class="timestamp">{t('history.time')}: {
                        (() => {
                          const date = new Date(record.timestamp * 1000);
                          // Define language-specific date and time formats
                          if (lang === 'en') {
                            return date.toLocaleDateString('en-US', {
                              year: 'numeric',
                              month: 'numeric',
                              day: 'numeric'
                            }) + ' ' + date.toLocaleTimeString('en-US', {
                              hour: '2-digit',
                              minute: '2-digit',
                              second: '2-digit',
                              hour12: false
                            });
                          } else if (lang === 'cn' || lang === 'hk') {
                            return date.toLocaleDateString('zh-CN', {
                              year: 'numeric',
                              month: 'long',
                              day: 'numeric'
                            }) + ' ' + date.toLocaleTimeString('zh-CN', {
                              hour: '2-digit',
                              minute: '2-digit',
                              second: '2-digit',
                              hour12: false
                            });
                          } else if (lang === 'fr') {
                            return date.toLocaleDateString('fr-FR', {
                              year: 'numeric',
                              month: 'numeric',
                              day: 'numeric'
                            }) + ' ' + date.toLocaleTimeString('fr-FR', {
                              hour: '2-digit',
                              minute: '2-digit',
                              second: '2-digit',
                              hour12: false
                            });
                          } else if (lang === 'jp') {
                            return date.toLocaleDateString('ja-JP', {
                              year: 'numeric',
                              month: 'long',
                              day: 'numeric'
                            }) + ' ' + date.toLocaleTimeString('ja-JP', {
                              hour: '2-digit',
                              minute: '2-digit',
                              second: '2-digit',
                              hour12: false
                            });
                          } else {
                            // Fallback to default locale
                            return date.toLocaleString(lang);
                          }
                        })()
                      }</div>
                      <div class="images-count">{t('history.imagesCount')}: {images.length}</div>
                    </div>
                    <div class="history-actions">
                      <a href={`/history/${record.execution_id}`} class="btn secondary">{t('history.viewDetails')}</a>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          <p>{t('history.noHistory')}</p>
        )}
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="/logout?next=/me">{t('me.logout')}</a>
      <button type="button" class="btn secondary" onclick="openResetPasswordModal()">{t('me.resetPassword')}</button>
    </div>

  </div>
  
  {/* Preview Modal */}
  <div id="preview-modal" class="preview-modal" style="display:none;">
    <span class="close" onclick="document.getElementById('preview-modal').style.display='none'">&times;</span>
    <img class="preview-modal-content" id="preview-image" />
  </div>

  {/* Reset Password Modal */}
  <div id="reset-password-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeResetPasswordModal()">&times;</span>
      <h2>{t('me.resetPassword')}</h2>
      <div id="reset-message" class="success-message" style="display:none;"></div>
      <div id="reset-error" class="error-message" style="display:none;"></div>
      <form id="reset-password-form" class="password-reset-form" method="POST">
        <input type="hidden" name="_method" value="PUT" />
        <div class="form-group">
          <label for="modal_current_password">{t('me.currentPassword')}:</label>
          <input type="password" id="modal_current_password" name="current_password" required />
        </div>
        <div class="form-group">
          <label for="modal_new_password">{t('me.newPassword')}:</label>
          <input type="password" id="modal_new_password" name="new_password" required minlength="6" />
        </div>
        <div class="form-group">
          <label for="modal_confirm_password">{t('me.confirmNewPassword')}:</label>
          <input type="password" id="modal_confirm_password" name="confirm_password" required minlength="6" />
        </div>
        <button type="submit" class="btn">{t('me.resetPasswordButton')}</button>
      </form>
    </div>
  </div>
  
  <script>
    {/* Client-side script to handle image preview */}
    {/* This script runs after the page is hydrated */}
    document.addEventListener('DOMContentLoaded', () => {
      // Add click event listeners to all history images
      const images = document.querySelectorAll('.history-image');
      images.forEach(img => {
        img.addEventListener('click', (e) => {
          const target = e.target as HTMLImageElement;
          const src = target.getAttribute('data-preview-src');
          const executionId = target.getAttribute('data-execution-id');
          
          if (src) {
            // Set the source of the preview image
            const previewImage = document.getElementById('preview-image') as HTMLImageElement;
            if (previewImage) {
              previewImage.src = src;
            }
            
            // Show the preview modal
            const modal = document.getElementById('preview-modal');
            if (modal) {
              modal.style.display = 'block';
            }
          }
        });
      });
      
      // Add click event listener to close the modal when clicking on the close button or outside the image
      const modal = document.getElementById('preview-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal || (e.target as HTMLElement).classList.contains('close')) {
            modal.style.display = 'none';
          }
        });
      }

      // Reset Password Modal Functions
      (window as any).openResetPasswordModal = function() {
        const modal = document.getElementById('reset-password-modal') as HTMLElement;
        if (modal) {
          modal.style.display = 'block';
        }
      };

      (window as any).closeResetPasswordModal = function() {
        const modal = document.getElementById('reset-password-modal') as HTMLElement;
        if (modal) {
          modal.style.display = 'none';
          // Clear messages
          const messageEl = document.getElementById('reset-message') as HTMLElement;
          const errorEl = document.getElementById('reset-error') as HTMLElement;
          if (messageEl) messageEl.style.display = 'none';
          if (errorEl) errorEl.style.display = 'none';
          // Clear form
          const form = document.getElementById('reset-password-form') as HTMLFormElement;
          if (form) form.reset();
        }
      };

      // Handle form submission
      const resetForm = document.getElementById('reset-password-form') as HTMLFormElement;
      if (resetForm) {
        resetForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(resetForm);
          const currentPassword = formData.get('current_password')?.toString() || '';
          const newPassword = formData.get('new_password')?.toString() || '';
          const confirmPassword = formData.get('confirm_password')?.toString() || '';

          // Clear previous messages
          const messageEl = document.getElementById('reset-message') as HTMLElement;
          const errorEl = document.getElementById('reset-error') as HTMLElement;
          if (messageEl) messageEl.style.display = 'none';
          if (errorEl) errorEl.style.display = 'none';

          // Validate
          if (!currentPassword || !newPassword || !confirmPassword) {
            if (errorEl) {
              errorEl.textContent = '所有字段都是必填的';
              errorEl.style.display = 'block';
            }
            return;
          }
          if (newPassword !== confirmPassword) {
            if (errorEl) {
              errorEl.textContent = '新密码和确认密码不匹配';
              errorEl.style.display = 'block';
            }
            return;
          }
          if (newPassword.length < 6) {
            if (errorEl) {
              errorEl.textContent = '新密码长度至少为6位';
              errorEl.style.display = 'block';
            }
            return;
          }

          try {
           // Parse cookies using the same logic as api/client.ts
           function parseCookie(cookieHeader: string | undefined | null): Record<string, string> {
             const out: Record<string, string> = {};
             if (!cookieHeader) return out;
             const parts = cookieHeader.split(';');
             for (const p of parts) {
               const idx = p.indexOf('=');
               if (idx === -1) continue;
               const k = decodeURIComponent(p.slice(0, idx).trim());
               const v = decodeURIComponent(p.slice(idx + 1).trim());
               if (k) out[k] = v;
             }
             return out;
           }

           function getTokenFromCookies(cookies?: string): string | null {
             const map = parseCookie(cookies || '');
             return map['auth_token'] || map['auth_token_js'] || null;
           }

           // Get auth token from cookies
           const cookies = document.cookie;
           const token = getTokenFromCookies(cookies);
           
           // Send request to reset password
           const response = await fetch('/api/v1/auth/me/reset-password', {
             method: 'PUT',
             headers: {
               'Content-Type': 'application/json',
               ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
             },
             body: JSON.stringify({
               current_password: currentPassword,
               new_password: newPassword,
             }),
           });

            if (response.ok) {
              if (messageEl) {
                messageEl.textContent = '密码重置成功';
                messageEl.style.display = 'block';
              }
              setTimeout(() => {
                (window as any).closeResetPasswordModal();
              }, 2000);
            } else {
              const error = await response.json();
              if (errorEl) {
                errorEl.textContent = error.message || '密码重置失败';
                errorEl.style.display = 'block';
              }
            }
          } catch (error) {
            console.error('密码重置失败:', error);
            if (errorEl) {
              errorEl.textContent = '密码重置失败';
              errorEl.style.display = 'block';
            }
          }
        });
      }

      // Close modal when clicking outside
      const resetModal = document.getElementById('reset-password-modal') as HTMLElement;
      if (resetModal) {
        resetModal.addEventListener('click', (e) => {
          if (e.target === resetModal) {
            (window as any).closeResetPasswordModal();
          }
        });
      }
    });
  </script>
</Layout>

<style>
  .me-page {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .title {
    margin: 0 0 8px 0;
    font-size: 24px;
    color: var(--text-primary);
  }
  .section {
    margin-bottom: 20px;
  }
  .section h2 {
    margin: 0 0 10px 0;
    font-size: 20px;
    color: var(--text-primary);
  }
  .card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
  }
  .json {
    margin: 0;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-primary);
    font-size: 0.9rem;
  }
  .actions {
    display: flex;
    gap: 10px;
  }
  .btn {
    display: inline-block;
    padding: 10px 12px;
    border-radius: 8px;
    text-decoration: none;
    background: var(--accent-color);
    color: #fff;
    border: 1px solid var(--accent-color);
  }
  .btn.secondary {
    background: transparent;
    color: var(--accent-color);
  }
  .btn.logout-btn {
    background: #dc2626;
    border-color: #dc2626;
  }
  .btn.logout-btn:hover {
    background: #b91c1c;
    border-color: #b91c1c;
  }
  .rbac-demo {
    margin-top: 12px;
  }
  .admin-only {
    margin-top: 8px;
    padding: 10px 12px;
    background: rgba(59,130,246,0.1);
    border: 1px solid var(--accent-color);
    border-radius: 8px;
  }
  
  /* History styles */
  .history-container {
    padding: 0;
  }
  
  .history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    padding: 16px;
  }
  
  .history-item {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .history-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }
  
  .history-header {
    padding: 12px;
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-color);
  }
  
  .execution-id, .workflow-id {
    display: block;
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .history-content {
    padding: 12px;
  }
  
  .image-container {
    width: 100%;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border-radius: 8px;
    background: var(--bg-primary);
    margin-bottom: 12px;
  }
  
  .history-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  
  .no-image {
    width: 100%;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    font-style: italic;
  }
  
  .history-details {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }
  
  .timestamp, .images-count {
    margin-bottom: 4px;
  }
  
  /* Preview Modal Styles */
  .preview-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.9);
  }
  
  .preview-modal-content {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    max-height: 80%;
    object-fit: contain;
    animation-name: zoom;
    animation-duration: 0.3s;
  }
  
  @keyframes zoom {
    from {transform: scale(0)}
    to {transform: scale(1)}
  }
  
  .close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .close:hover,
  .close:focus {
    color: #bbb;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    background-color: var(--bg-secondary);
    margin: 15% auto;
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    color: var(--text-primary);
  }

  .modal-content .close {
    color: var(--text-secondary);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .modal-content .close:hover,
  .modal-content .close:focus {
    color: var(--text-primary);
  }

  .modal-content h2 {
    margin-top: 0;
    color: var(--text-primary);
  }

  /* Password reset form styles */
  .password-reset-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
 }
  
  .form-group label {
    font-weight: 500;
    color: var(--text-primary);
  }
  
  .form-group input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 1rem;
  }
  
  .form-group input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }
  
 .success-message {
    padding: 10px 12px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid #22c55e;
    border-radius: 8px;
    color: #22c55e;
    margin-bottom: 16px;
  }
  
  .error-message {
    padding: 10px 12px;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    border-radius: 8px;
    color: #ef4444;
    margin-bottom: 16px;
 }
/* User info card styles */
.user-info-card {
  display: block;
  gap: 12px;
}
.user-main {
  display: flex;
  gap: 12px;
  align-items: center;
}
.avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: #fff;
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  font-size: 20px;
  flex: 0 0 56px;
  border: 2px solid rgba(255,255,255,0.06);
}
.user-meta .user-row {
  margin-bottom: 6px;
  font-size: 0.95rem;
  color: var(--text-primary);
}
.badge {
  display: inline-block;
  padding: 4px 8px;
  margin-right: 6px;
  background: var(--accent-color);
  color: #fff;
  border-radius: 999px;
  font-size: 0.8rem;
}
.muted {
  color: var(--text-secondary);
  font-style: italic;
}
.token-info {
  margin-top: 12px;
  font-size: 0.9rem;
  color: var(--text-secondary);
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.raw-json summary {
  cursor: pointer;
  font-weight: 600;
  color: var(--text-primary);
}
.raw-json pre.json {
  background: transparent;
  border: 1px dashed var(--border-color);
  padding: 10px;
  border-radius: 8px;
  max-height: 300px;
  overflow: auto;
}
</style>